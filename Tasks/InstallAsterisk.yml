# Run with:
# ansible-playbook InstallAsterisk.yml

---
- name: Install Asterisk
  hosts: all
  vars:
     asterisk_version: "asterisk-23.1.0"
  tasks:

#Install some prerequesits
  - name: Install MPG123 package on OpenSUSE/SUSE Linux
    zypper:
      name: mpg123
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install MPG123 package on Raspberian Linux
    apt:
      name: mpg123
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install Autoconf package on OpenSUSE/SUSE Linux
    zypper:
      name: autoconf
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install Autoconf package on Raspberian Linux
    apt:
      name: autoconf
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install LibJSonCpp package on OpenSUSE/SUSE Linux
    zypper:
      name: libjsoncpp*
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install LibJSonCpp package on Raspberian Linux
    apt:
      name: libjsoncpp26
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install Automake package on OpenSUSE/SUSE Linux
    zypper:
      name: automake
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install Automake package on Raspberian Linux
    apt:
      name: automake
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install Flex package on OpenSUSE/SUSE Linux
    zypper:
      name: flex
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install Flex package on Raspberian Linux
    apt:
      name: flex
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install M4 package on OpenSUSE/SUSE Linux
    zypper:
      name: m4
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install M4 package on Raspberian Linux
    apt:
      name: m4
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install NodeJS package on OpenSUSE/SUSE Linux
    zypper:
      name: nodejs22
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install NodeJS package on Raspberian Linux
    apt:
      name: nodejs
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install NodeJS-Common package on OpenSUSE/SUSE Linux
    zypper:
      name: nodejs-common
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install NPM package on OpenSUSE/SUSE Linux
    zypper:
      name: npm22
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install NPM package on Raspberian Linux
    apt:
      name: npm
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install UnixODBC package on OpenSUSE/SUSE Linux
    zypper:
      name: unixODBC
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install UnixODBC package on Raspberian Linux
    apt:
      name: unixodbc
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install UnixODBC-devel package on OpenSUSE/SUSE Linux
    zypper:
      name: unixODBC-devel
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") != -1

  - name: Install UnixODBC-dev package on Raspberian Linux
    apt:
      name: unixodbc-dev
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install libedit-dev package on Raspberian Linux
    apt:
      name: libedit-dev
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install libxml2-dev package on Raspberian Linux
    apt:
      name: libxml2-dev
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install SQLite3 package on Raspberian Linux
    apt:
      name: sqlite3
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Install SQLite3-dev package on Raspberian Linux
    apt:
      name: libsqlite3-dev
      state: present
    when:
    - ansible_facts['distribution'].find("openSUSE") == -1

  - name: Check if Asterisk download exists
    stat:
      path: /root/{{asterisk_version}}.tar.gz
    register: asterisk_exists

  - name: Download Asterisk
    ansible.builtin.get_url:
      url: http://downloads.asterisk.org/pub/telephony/asterisk/{{asterisk_version}}.tar.gz
      dest: /root/{{asterisk_version}}.tar.gz
      mode: '1777'
    when: asterisk_exists.stat.exists == false

  - name: Unarchive Asterisk
    ansible.builtin.unarchive:
      src: /root/{{asterisk_version}}.tar.gz 
      dest: /root
      remote_src: yes
      creates: /root/{{asterisk_version}}

  - name: Check if Asterisk has been built exists
    stat:
      path: /root/{{asterisk_version}}/main/asterisk
    register: asteriskbuilt_exists

  - name: Set use MP3 define
    ansible.builtin.shell: sed -i 's|\(^#define DEVICE_FRAME_SIZE \).*|\164|' addons/chan_mobile.c
    args:
      chdir: /root/{{asterisk_version}}

# Switch repo due to connectivity issues
#  - name: Change MP3 repo
#    ansible.builtin.shell: sed -i 's|svn export https:\/\/svn\.digium\.com\/svn\/thirdparty\/mp3\/trunk|git clone --depth=1 https:\/\/github\.com\/ajorians\/thirdparty-mp3|' contrib/scripts/get_mp3_source.sh
#    args:
#      chdir: /root/{{asterisk_version}}

  - name: Run Asterisk MP3 script
    ansible.builtin.shell: contrib/scripts/get_mp3_source.sh
    args:
      chdir: /root/{{asterisk_version}}
      creates: addons/mp3

  - name: Configure Asterisk
    ansible.builtin.shell: ./configure --with-pjproject-bundled --with-jansson-bundled
    args:
      chdir: /root/{{asterisk_version}}
      creates: makeopts
    when: asteriskbuilt_exists.stat.exists == false

  - name: Make Asterisk Menuselect
    ansible.builtin.shell: make menuselect.makeopts
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: MenuSelect IAX2
    ansible.builtin.shell: menuselect/menuselect --enable chan_iax2 menuselect.makeopts
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: MenuSelect Core Sounds 1
    ansible.builtin.shell: menuselect/menuselect --enable CORE-SOUNDS-EN-WAV --enable CORE-SOUNDS-EN-ULAW menuselect.makeopts
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: MenuSelect Core Sounds 2
    ansible.builtin.shell: menuselect/menuselect --enable CORE-SOUNDS-EN-GSM --enable CORE-SOUNDS-EN-G722 menuselect.makeopts
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: MenuSelect MP3
    ansible.builtin.shell: menuselect/menuselect --enable format_mp3 --enable chan_mobile menuselect.makeopts
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: Make Asterisk
    ansible.builtin.shell: make
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskbuilt_exists.stat.exists == false

  - name: Check if Asterisk install exists
    stat:
      path: /sbin/asterisk
    register: asteriskinstalled_exists

  - name: Make Install Asterisk
    ansible.builtin.shell: make install
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskinstalled_exists.stat.exists == false

# We could not install init scripts for your distribution.
#  - name: Make Config Asterisk
#    ansible.builtin.shell: make config
#    args:
#      chdir: /root/{{asterisk_version}}
#    when: asteriskinstalled_exists.stat.exists == false

  - name: Make Samples Asterisk
    ansible.builtin.shell: make samples
    args:
      chdir: /root/{{asterisk_version}}
    when: asteriskinstalled_exists.stat.exists == false

  - name: Reload Libraries
    ansible.builtin.shell: ldconfig
    when: asteriskinstalled_exists.stat.exists == false

  - name: Ensure group "asterisk" exists
    ansible.builtin.group:
      name: asterisk
      state: present

  - name: Add the user 'asterisk' with group of 'asterisk'
    ansible.builtin.user:
      name: asterisk
      comment: Asterisk
      group: asterisk

  - name: Recursively change ownership of /var/run/asterisk
    ansible.builtin.file:
      path: /var/run/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Recursively change ownership of /etc/asterisk
    ansible.builtin.file:
      path: /etc/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Recursively change ownership of /var/lib/asterisk
    ansible.builtin.file:
      path: /var/lib/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Recursively change ownership of /var/log/asterisk
    ansible.builtin.file:
      path: /var/log/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Recursively change ownership of /var/spool/asterisk
    ansible.builtin.file:
      path: /var/spool/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Recursively change ownership of /usr/lib/asterisk
    ansible.builtin.file:
      path: /usr/lib/asterisk
      state: directory
      recurse: yes
      owner: asterisk
      group: asterisk

  - name: Create a symbolic link
    ansible.builtin.file:
      src: /sbin/asterisk
      dest: /usr/local/bin/asterisk
      state: link

# Can't figure this out yet
#  - name: Add Asterisk shutdown to sudoers
#    ansible.builtin.lineinfile:
#      path: /etc/sudoers
#      line: 'asterisk ALL = NOPASSWD: /sbin/shutdown'

#  - name: Add Asterisk reboot to sudoers
#    ansible.builtin.lineinfile:
#      path: /etc/sudoers
#      line: 'asterisk ALL = NOPASSWD: /sbin/reboot'

